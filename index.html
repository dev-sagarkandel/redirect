<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gravity Battery Simulator</title>
    
    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        canvas {
            touch-action: none;
        }
        .tooltip {
            visibility: hidden;
            position: absolute;
            z-index: 50;
            width: 200px;
            text-align: center;
        }
        .has-tooltip:hover .tooltip {
            visibility: visible;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons ---
        const InfoIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="inline-block text-blue-500 hover:text-blue-700 cursor-help ml-1"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
        );

        const PlayIcon = () => (
             <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>
        );

        const RotateCwIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 4v6h-6"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
        );

        const CopyIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
        );

        // --- Helper: Copy Data ---
        const copyDataToClipboard = (data, headers) => {
            if (!data || data.length === 0) return;
            const csvContent = [
                headers.join(','),
                ...data.map(row => row.join(','))
            ].join('\n');
            
            navigator.clipboard.writeText(csvContent).then(() => {
                // UI feedback handled by button usually
            });
        };

        // --- Chart Component ---
        const ChartComponent = ({ data, datasets, xLabel, yLabel, xMax, reverseX = false, isTime = false }) => {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            const handleCopy = () => {
                let rows = [];
                if (datasets.length === 1) {
                    rows = datasets[0].data.map(p => [p.x, p.y]);
                    copyDataToClipboard(rows, [xLabel, datasets[0].label]);
                } else {
                    rows = datasets.flatMap(ds => ds.data.map(p => [ds.label, p.x, p.y]));
                    copyDataToClipboard(rows, ['Series', xLabel, yLabel]);
                }
            };

            useEffect(() => {
                if (!canvasRef.current) return;
                const ctx = canvasRef.current.getContext('2d');
                if (chartRef.current) chartRef.current.destroy();

                chartRef.current = new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: datasets.map(ds => ({
                            label: ds.label,
                            data: ds.data,
                            borderColor: ds.color,
                            backgroundColor: ds.color + '20',
                            borderWidth: 2,
                            showLine: true,
                            pointRadius: 0, // Clean line
                            tension: 0.1,
                            fill: ds.fill || false
                        }))
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: false,
                        interaction: { intersect: false, mode: 'nearest' },
                        scales: {
                            x: {
                                type: 'linear',
                                position: 'bottom',
                                min: 0,
                                max: xMax,
                                title: { display: true, text: xLabel },
                                reverse: reverseX 
                            },
                            y: {
                                title: { display: true, text: yLabel },
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            legend: { display: datasets.length > 1 },
                            tooltip: {
                                callbacks: {
                                    label: (context) => `${context.dataset.label}: ${context.parsed.y.toFixed(2)}`
                                }
                            }
                        }
                    }
                });

                return () => { if (chartRef.current) chartRef.current.destroy(); };
            }, [xMax, reverseX, xLabel, yLabel]);

            // Efficient Data Update
            useEffect(() => {
                if (chartRef.current) {
                    const chart = chartRef.current;
                    datasets.forEach((ds, i) => {
                        if (chart.data.datasets[i]) {
                            chart.data.datasets[i].data = ds.data;
                        } else {
                            chart.data.datasets.push({
                                label: ds.label,
                                data: ds.data,
                                borderColor: ds.color,
                                backgroundColor: ds.color + '20',
                                borderWidth: 2,
                                showLine: true,
                                pointRadius: 0,
                                fill: ds.fill || false
                            });
                        }
                    });
                    
                    if (!xMax) {
                        chart.options.scales.x.max = undefined;
                    }

                    chart.update('none');
                }
            }, [datasets, xMax]);

            return (
                <div className="relative w-full h-full group">
                    <canvas ref={canvasRef} />
                    <button 
                        onClick={handleCopy}
                        className="absolute top-1 right-1 p-1 bg-white hover:bg-slate-50 text-slate-400 hover:text-slate-600 rounded border border-slate-200 shadow-sm opacity-0 group-hover:opacity-100 transition-opacity z-10"
                        title="Copy Data to Clipboard"
                    >
                        <CopyIcon />
                    </button>
                </div>
            );
        };

        // --- Main Application ---
        const App = () => {
            const [params, setParams] = useState({
                mass: 0.3, height: 0.7, gravity: 9.81, pulleyRadius: 0.02,
                rpm: 100, mechEff: 85, genEff: 80, loadRes: 10, delay: 2
            });

            const [simState, setSimState] = useState({
                status: 'IDLE',
                currentHeight: 0.7,
                time: 0,
                velocity: 0,
                power: 0, voltage: 0, current: 0,
                energyGenerated: 0, energyConsumed: 0
            });

            const [cycleStats, setCycleStats] = useState({ generated: 0, consumed: 0, count: 0 });
            const [isContinuous, setIsContinuous] = useState(false);
            const [errorMsg, setErrorMsg] = useState('');

            // Data History (Render State)
            const [history, setHistory] = useState({
                power: [], voltage: [], current: [],
                energyGen: [], energyCons: []
            });

            // Refs for Animation Loop
            const requestRef = useRef();
            const lastTimeRef = useRef();
            const stateRef = useRef(simState);
            const paramsRef = useRef(params);
            
            // Mutable History Ref for Animation Loop
            const historyRef = useRef({
                power: [], voltage: [], current: [],
                energyGen: [], energyCons: []
            });

            useEffect(() => { stateRef.current = simState; }, [simState]);
            useEffect(() => { paramsRef.current = params; }, [params]);

            // --- Physics Engine ---
            const updatePhysics = (dt) => {
                const s = { ...stateRef.current };
                const p = paramsRef.current;
                
                const vTerm = (p.rpm * 2 * Math.PI / 60) * p.pulleyRadius;
                const dampingK = (p.mass * p.gravity) / vTerm;

                if (s.status === 'FALLING') {
                    // Descent Dynamics
                    const accel = p.gravity - (dampingK * s.velocity / p.mass);
                    s.velocity += accel * dt;
                    s.currentHeight -= s.velocity * dt;

                    // Power Gen
                    const fDrag = dampingK * s.velocity;
                    const pMechInput = fDrag * s.velocity;
                    const pElec = pMechInput * (p.mechEff / 100) * (p.genEff / 100);

                    s.power = pElec;
                    s.voltage = Math.sqrt(pElec * p.loadRes);
                    s.current = s.voltage / p.loadRes;
                    s.energyGenerated += s.power * dt;

                    // Check for Ground Impact
                    if (s.currentHeight <= 0) {
                        s.currentHeight = 0; // Clamp
                        
                        // CRITICAL FIX: Push the final point at x=0 explicitly so graph touches axis
                        historyRef.current.power.push({ x: 0, y: s.power });
                        historyRef.current.voltage.push({ x: 0, y: s.voltage });
                        historyRef.current.current.push({ x: 0, y: s.current });

                        // Transition
                        s.status = 'WAITING';
                        s.waitTimer = 0;
                        s.velocity = 0;
                        s.power = 0; s.voltage = 0; s.current = 0; // Reset metrics after logging impact
                    } else {
                        // Normal Logging
                        const h = parseFloat(s.currentHeight.toFixed(3));
                        historyRef.current.power.push({ x: h, y: s.power });
                        historyRef.current.voltage.push({ x: h, y: s.voltage });
                        historyRef.current.current.push({ x: h, y: s.current });
                    }

                } else if (s.status === 'WAITING') {
                    s.waitTimer += dt;
                    if (s.waitTimer >= p.delay) {
                        s.status = 'LIFTING';
                    }

                } else if (s.status === 'LIFTING') {
                    // Lifting Dynamics
                    const liftSpeed = vTerm; 
                    s.velocity = -liftSpeed;
                    s.currentHeight += liftSpeed * dt;

                    // Power Consumption
                    const pLoad = p.mass * p.gravity * liftSpeed;
                    const effFactor = (p.mechEff / 100) * (p.genEff / 100);
                    const pInput = pLoad / effFactor;

                    s.power = -pInput;
                    s.voltage = 0; s.current = 0;
                    s.energyConsumed += pInput * dt;

                    if (s.currentHeight >= p.height) {
                        s.currentHeight = p.height;
                        
                        // Cycle Complete
                        setCycleStats(prev => ({
                            generated: s.energyGenerated,
                            consumed: s.energyConsumed,
                            count: prev.count + 1
                        }));

                        if (isContinuous) {
                            s.status = 'FALLING';
                            // Reset per-cycle energy
                            s.energyGenerated = 0;
                            s.energyConsumed = 0;
                            // Clear graph history for new clean plot
                            historyRef.current.power = [];
                            historyRef.current.voltage = [];
                            historyRef.current.current = [];
                        } else {
                            s.status = 'IDLE';
                        }
                        s.power = 0; s.velocity = 0;
                    }
                }

                s.time += dt;
                
                // Continuous Energy Logging (Time based)
                if (!s.lastLogTime || s.time - s.lastLogTime > 0.1) {
                    historyRef.current.energyGen.push({ x: s.time, y: s.energyGenerated }); 
                    historyRef.current.energyCons.push({ x: s.time, y: s.energyConsumed });
                    s.lastLogTime = s.time;
                }

                setSimState(s);
            };

            const animate = (time) => {
                if (stateRef.current.status === 'IDLE') {
                    lastTimeRef.current = undefined;
                    requestRef.current = requestAnimationFrame(animate);
                    return;
                }

                if (lastTimeRef.current !== undefined) {
                    const dt = (time - lastTimeRef.current) / 1000;
                    if (dt < 0.1) {
                        updatePhysics(dt);
                        setHistory({ ...historyRef.current });
                    }
                }
                lastTimeRef.current = time;
                requestRef.current = requestAnimationFrame(animate);
            };

            useEffect(() => {
                requestRef.current = requestAnimationFrame(animate);
                return () => cancelAnimationFrame(requestRef.current);
            }, [isContinuous]);

            // --- Handlers ---
            const handleStart = () => {
                if (params.mass <= 0 || params.height <= 0 || params.rpm <= 0) {
                    setErrorMsg("Positive values required.");
                    return;
                }
                setErrorMsg('');
                
                // Reset Histories
                historyRef.current = { power: [], voltage: [], current: [], energyGen: [], energyCons: [] };
                setHistory(historyRef.current);
                setCycleStats({ generated: 0, consumed: 0, count: 0 });

                setSimState(prev => ({
                    ...prev,
                    status: 'FALLING',
                    time: 0,
                    energyGenerated: 0,
                    energyConsumed: 0,
                    currentHeight: params.height,
                    velocity: 0,
                    lastLogTime: 0
                }));
                lastTimeRef.current = undefined;
            };

            const handleReset = () => {
                setSimState({
                    status: 'IDLE',
                    currentHeight: params.height,
                    time: 0,
                    velocity: 0,
                    power: 0, voltage: 0, current: 0,
                    energyGenerated: 0, energyConsumed: 0
                });
                historyRef.current = { power: [], voltage: [], current: [], energyGen: [], energyCons: [] };
                setHistory(historyRef.current);
                setCycleStats({ generated: 0, consumed: 0, count: 0 });
                lastTimeRef.current = undefined;
            };

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                setParams(prev => ({ ...prev, [name]: parseFloat(value) }));
            };

            // --- Canvas Viz ---
            const CanvasViz = () => {
                const canvasRef = useRef(null);
                useEffect(() => {
                    const canvas = canvasRef.current;
                    const ctx = canvas.getContext('2d');
                    const draw = () => {
                        const w = canvas.width;
                        const h = canvas.height;
                        const s = stateRef.current;
                        const p = paramsRef.current;
                        ctx.clearRect(0, 0, w, h);

                        const groundY = h - 10;
                        const topY = 20;
                        const pulleyX = w / 2;
                        const availableHeight = groundY - topY - 40; // Reduced height for smaller model
                        const scaleY = availableHeight / p.height; 

                        // Frame
                        ctx.strokeStyle = '#cbd5e1'; ctx.lineWidth = 3;
                        ctx.beginPath();
                        ctx.moveTo(pulleyX - 50, groundY); ctx.lineTo(pulleyX - 50, topY);
                        ctx.lineTo(pulleyX + 50, topY); ctx.lineTo(pulleyX + 50, groundY);
                        ctx.stroke();

                        // Pulley
                        ctx.fillStyle = s.status === 'FALLING' ? '#22c55e' : (s.status === 'LIFTING' ? '#ef4444' : '#64748b');
                        ctx.beginPath(); ctx.arc(pulleyX, topY, 15, 0, Math.PI * 2); ctx.fill();
                        
                        // Spokes
                        ctx.strokeStyle = 'white'; ctx.lineWidth = 2;
                        ctx.save(); ctx.translate(pulleyX, topY);
                        const rotation = (p.height - s.currentHeight) * 15; 
                        ctx.rotate(rotation); 
                        ctx.beginPath(); ctx.moveTo(-10, 0); ctx.lineTo(10, 0); ctx.moveTo(0, -10); ctx.lineTo(0, 10); ctx.stroke();
                        ctx.restore();

                        // Rope & Mass
                        const massY = topY + 15 + (p.height - s.currentHeight) * scaleY;
                        ctx.strokeStyle = '#334155'; ctx.lineWidth = 2;
                        ctx.beginPath(); ctx.moveTo(pulleyX, topY + 15); ctx.lineTo(pulleyX, massY); ctx.stroke();

                        ctx.fillStyle = '#475569';
                        ctx.fillRect(pulleyX - 15, massY, 30, 30);
                        
                        // Ground
                        ctx.strokeStyle = '#94a3b8'; ctx.lineWidth = 3;
                        ctx.beginPath(); ctx.moveTo(20, groundY); ctx.lineTo(w-20, groundY); ctx.stroke();

                        requestAnimationFrame(draw);
                    };
                    draw();
                }, []);
                return <canvas ref={canvasRef} width={250} height={200} className="w-full h-full object-contain" />;
            };

            return (
                <div className="min-h-screen p-4 md:p-6 max-w-7xl mx-auto flex flex-col font-sans text-slate-800">
                    <header className="mb-6 flex justify-between items-end border-b pb-4">
                        <div>
                            <h1 className="text-3xl font-bold text-slate-900 tracking-tight">Gravity Battery Simulator</h1>
                            <p className="text-slate-500 text-sm mt-1">Prototype analysis: {params.mass}kg @ {params.height}m</p>
                        </div>
                        <div className="text-right hidden sm:block">
                            <div className="text-xs text-slate-400 uppercase tracking-wider font-semibold">System Status</div>
                            <div className={`font-bold ${simState.status==='FALLING'?'text-green-600':simState.status==='LIFTING'?'text-red-500':'text-slate-600'}`}>
                                {simState.status}
                            </div>
                        </div>
                    </header>

                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 flex-grow">
                        
                        {/* LEFT: Controls (3 cols) */}
                        <div className="lg:col-span-3 space-y-4">
                            <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                                <h2 className="text-sm font-bold text-slate-800 mb-4 uppercase tracking-wider">Controls</h2>
                                <div className="flex gap-2 mb-3">
                                    {simState.status === 'IDLE' ? (
                                        <button onClick={handleStart} className="flex-1 bg-blue-600 text-white px-4 py-2.5 rounded-lg hover:bg-blue-700 active:bg-blue-800 flex justify-center items-center gap-2 font-semibold transition-all">
                                            <PlayIcon /> START
                                        </button>
                                    ) : (
                                        <button onClick={handleReset} className="flex-1 bg-slate-100 text-slate-700 px-4 py-2.5 rounded-lg hover:bg-slate-200 border border-slate-200 flex justify-center items-center gap-2 font-semibold transition-all">
                                            <RotateCwIcon /> RESET
                                        </button>
                                    )}
                                </div>
                                <label className="flex items-center gap-3 p-3 rounded-lg border border-transparent hover:bg-slate-50 cursor-pointer transition-colors">
                                    <div className="relative flex items-center">
                                        <input type="checkbox" checked={isContinuous} onChange={(e) => setIsContinuous(e.target.checked)} className="peer h-5 w-5 cursor-pointer appearance-none rounded-md border border-slate-300 transition-all checked:border-blue-600 checked:bg-blue-600" />
                                        <div className="pointer-events-none absolute top-2/4 left-2/4 -translate-x-2/4 -translate-y-2/4 text-white opacity-0 transition-opacity peer-checked:opacity-100">
                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" /></svg>
                                        </div>
                                    </div>
                                    <span className="text-sm font-medium text-slate-700">Continuous Cycle</span>
                                </label>
                            </div>

                            <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-200 max-h-[500px] overflow-y-auto">
                                <h2 className="text-sm font-bold text-slate-800 mb-4 uppercase tracking-wider">Parameters</h2>
                                <div className="space-y-4">
                                    <div>
                                        <label className="text-xs text-slate-500 font-bold uppercase mb-1 block">Mass (kg)</label>
                                        <input type="number" name="mass" value={params.mass} onChange={handleInputChange} step="0.1" className="w-full bg-slate-50 border border-slate-200 rounded p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" disabled={simState.status !== 'IDLE'} />
                                    </div>
                                    <div>
                                        <label className="text-xs text-slate-500 font-bold uppercase mb-1 block">Height (m)</label>
                                        <input type="number" name="height" value={params.height} onChange={handleInputChange} step="0.1" className="w-full bg-slate-50 border border-slate-200 rounded p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" disabled={simState.status !== 'IDLE'} />
                                    </div>
                                    <div>
                                        <label className="text-xs text-slate-500 font-bold uppercase mb-1 block has-tooltip flex items-center">
                                            Motor RPM <InfoIcon />
                                            <span className="tooltip bg-slate-800 text-white p-2 rounded text-xs -mt-8 ml-2">Controls descent speed (back-EMF)</span>
                                        </label>
                                        <input type="number" name="rpm" value={params.rpm} onChange={handleInputChange} className="w-full bg-slate-50 border border-slate-200 rounded p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" disabled={simState.status !== 'IDLE'} />
                                    </div>
                                    <div className="grid grid-cols-2 gap-2">
                                        <div>
                                            <label className="text-xs text-slate-500 font-bold uppercase mb-1 block">Mech Eff %</label>
                                            <input type="number" name="mechEff" value={params.mechEff} onChange={handleInputChange} className="w-full bg-slate-50 border border-slate-200 rounded p-2 text-sm" />
                                        </div>
                                        <div>
                                            <label className="text-xs text-slate-500 font-bold uppercase mb-1 block">Gen Eff %</label>
                                            <input type="number" name="genEff" value={params.genEff} onChange={handleInputChange} className="w-full bg-slate-50 border border-slate-200 rounded p-2 text-sm" />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="text-xs text-slate-500 font-bold uppercase mb-1 block">Resistance (&Omega;)</label>
                                        <input type="number" name="loadRes" value={params.loadRes} onChange={handleInputChange} className="w-full bg-slate-50 border border-slate-200 rounded p-2 text-sm" />
                                    </div>
                                    <div>
                                        <label className="text-xs text-slate-500 font-bold uppercase mb-1 block">Cycle Delay (s)</label>
                                        <input type="number" name="delay" value={params.delay} onChange={handleInputChange} className="w-full bg-slate-50 border border-slate-200 rounded p-2 text-sm" />
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* MIDDLE: Visual (3 cols) */}
                        <div className="lg:col-span-3 flex flex-col gap-4">
                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 flex-grow flex flex-col overflow-hidden">
                                <div className="bg-slate-50 p-3 border-b border-slate-100 flex justify-between items-center">
                                    <span className="text-xs font-bold text-slate-500 uppercase">System Model</span>
                                    <span className="text-xs font-mono text-slate-400">t: {simState.time.toFixed(1)}s</span>
                                </div>
                                <div className="relative h-64 bg-white">
                                    <CanvasViz />
                                    <div className="absolute bottom-2 left-2 right-2 bg-white/90 backdrop-blur border border-slate-200 p-2 rounded-lg shadow-sm">
                                        <div className="grid grid-cols-2 gap-4 text-sm">
                                            <div>
                                                <div className="text-xs text-slate-400 font-bold uppercase">Height</div>
                                                <div className="font-mono font-semibold">{simState.currentHeight.toFixed(2)}m</div>
                                            </div>
                                            <div>
                                                <div className="text-xs text-slate-400 font-bold uppercase">Speed</div>
                                                <div className="font-mono font-semibold">{Math.abs(simState.velocity).toFixed(2)}m/s</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Cycle Stats */}
                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
                                <h3 className="text-xs font-bold text-slate-500 uppercase mb-3">Cycle Statistics ({cycleStats.count})</h3>
                                <div className="space-y-3">
                                    <div className="flex justify-between items-center">
                                        <span className="text-sm text-slate-600">Generated</span>
                                        <span className="text-sm font-bold text-green-600 font-mono">
                                            {simState.status === 'FALLING' ? simState.energyGenerated.toFixed(2) : cycleStats.generated.toFixed(2)} J
                                        </span>
                                    </div>
                                    <div className="flex justify-between items-center">
                                        <span className="text-sm text-slate-600">Consumed</span>
                                        <span className="text-sm font-bold text-red-500 font-mono">
                                            {simState.status === 'LIFTING' ? simState.energyConsumed.toFixed(2) : cycleStats.consumed.toFixed(2)} J
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* RIGHT: Graphs (6 cols) */}
                        <div className="lg:col-span-6 flex flex-col gap-4">
                            {/* Live Metrics */}
                            <div className="grid grid-cols-3 gap-4">
                                <div className="bg-green-50 rounded-xl p-4 border border-green-100">
                                    <div className="text-xs font-bold text-green-700 uppercase mb-1">Power Out</div>
                                    <div className="text-2xl font-bold text-green-800">{simState.power > 0 ? simState.power.toFixed(2) : '0.00'} <span className="text-sm font-normal text-green-600">W</span></div>
                                </div>
                                <div className="bg-blue-50 rounded-xl p-4 border border-blue-100">
                                    <div className="text-xs font-bold text-blue-700 uppercase mb-1">Voltage</div>
                                    <div className="text-2xl font-bold text-blue-800">{simState.voltage.toFixed(2)} <span className="text-sm font-normal text-blue-600">V</span></div>
                                </div>
                                <div className="bg-amber-50 rounded-xl p-4 border border-amber-100">
                                    <div className="text-xs font-bold text-amber-700 uppercase mb-1">Current</div>
                                    <div className="text-2xl font-bold text-amber-800">{simState.current.toFixed(2)} <span className="text-sm font-normal text-amber-600">A</span></div>
                                </div>
                            </div>

                            {/* Charts Grid */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 flex-grow">
                                <div className="bg-white p-3 rounded-xl border border-slate-200 shadow-sm h-64 md:h-auto flex flex-col">
                                    <h4 className="text-xs font-bold text-slate-500 uppercase mb-2">Power vs Height</h4>
                                    <div className="flex-grow relative">
                                        <ChartComponent 
                                            datasets={[{label: 'Power', data: history.power, color: '#16a34a', fill: true}]} 
                                            xLabel="Height (m)" yLabel="Power (W)" xMax={params.height} reverseX={true}
                                        />
                                    </div>
                                </div>
                                <div className="bg-white p-3 rounded-xl border border-slate-200 shadow-sm h-64 md:h-auto flex flex-col">
                                    <h4 className="text-xs font-bold text-slate-500 uppercase mb-2">Voltage vs Height</h4>
                                    <div className="flex-grow relative">
                                        <ChartComponent 
                                            datasets={[{label: 'Voltage', data: history.voltage, color: '#2563eb', fill: true}]} 
                                            xLabel="Height (m)" yLabel="Voltage (V)" xMax={params.height} reverseX={true}
                                        />
                                    </div>
                                </div>
                                <div className="bg-white p-3 rounded-xl border border-slate-200 shadow-sm h-64 md:h-auto flex flex-col">
                                    <h4 className="text-xs font-bold text-slate-500 uppercase mb-2">Current vs Height</h4>
                                    <div className="flex-grow relative">
                                        <ChartComponent 
                                            datasets={[{label: 'Current', data: history.current, color: '#d97706', fill: true}]} 
                                            xLabel="Height (m)" yLabel="Current (A)" xMax={params.height} reverseX={true}
                                        />
                                    </div>
                                </div>
                                <div className="bg-white p-3 rounded-xl border border-slate-200 shadow-sm h-64 md:h-auto flex flex-col">
                                    <h4 className="text-xs font-bold text-slate-500 uppercase mb-2">Energy vs Time (Continuous)</h4>
                                    <div className="flex-grow relative">
                                        <ChartComponent 
                                            datasets={[
                                                {label: 'Generated (J)', data: history.energyGen, color: '#16a34a'},
                                                {label: 'Consumed (J)', data: history.energyCons, color: '#ef4444'}
                                            ]} 
                                            xLabel="Time (s)" yLabel="Energy (J)" isTime={true}
                                        />
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
